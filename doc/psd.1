.\" Text automatically generated by txt2man
.TH profile-sync-daemon 1 "07 September 2015" "" ""
.SH NAME
\fBprofile-sync-daemon \fP- Symlinks and syncs browser profiles to RAM (tmpfs) thus reducing HDD/SSD calls and speeding-up browsers.
\fB
.SH DESCRIPTION
Profile-sync-daemon (psd) is a tiny pseudo-daemon designed to manage browser \fBprofile\fP(s) in tmpfs and to periodically sync back to the physical disc (HDD/SSD). This is accomplished by an innovative use of rsync to maintain synchronization between a tmpfs copy and media-bound backup of the browser \fBprofile\fP(s). Additionally, psd features several crash recovery features.
.PP
Design goals of psd:
.RS
.IP \(bu 3
Completely transparent user experience.
.IP \(bu 3
Reduced wear to physical discs (particularly SSDs).
.IP \(bu 3
Speed.
.RE
.PP
Since the \fBprofile\fP(s), browser cache*, etc. are relocated into tmpfs (RAM disk), the corresponding onslaught of I/O associated with using the browser is also redirected from the physical disc to the RAM, thus reducing wear to the physical disc and also greatly improving browser responsiveness. For example, the access time of RAM is on the order of nanoseconds while the access time of physical discs is on the order of milliseconds. This is a difference of six orders of magnitude or 1,000,000 times faster.
.PP
*Note that some browsers such as Chrome/Chromium, Firefox (since v21), Midori, and Rekonq actually keeps their cache directories separately from their browser profile directory. It is not within the scope of profile-sync-daemon to modify this behavior; users wishing to relocate this directory, may refer to the following url for several work-arounds: https://wiki.archlinux.org/index.php/Chromium_Tips_and_Tweaks#Cache_in_tmpfs
.SH SETUP
$HOME/.psd/psd.conf contains all user managed settings.
.PP
WARNING -- Any edits made to $HOME/.psd/psd.conf while psd is running will be applied only after the psd.service has been restarted.
.RS
.IP \(bu 3
Optionally enable the use of overlayfs to improve sync speed even further and use a smaller memory footprint. Do this in the USE_OVERLAYFS variable. Your user will require sudo rights to /usr/bin/mount and /usr/bin/umount to use this option and your kernel must support overlayfs version 22 or higher. See the FAQ below for additional details.
.IP \(bu 3
Optionally uncomment and define which browsers are to be managed in the BROWSERS array. If none are defined, the default is all detected browsers.
.IP \(bu 3
Optionally define the location of your distro's tmpfs which is only used as a fall-back option should your systemd not correctly set $XDG_RUNTIME_DIR for you (/run/user/$UID). Do this in the VOLATILE variable.
.IP \(bu 3
Optionally disable the use of crash-recovery snapshots. Do this in the USE_BACKUPS variable.
.SH RUNNING PSD
.SS PREVIEW MODE
The preview (parse) option can be called to show users exactly what psd will do/is doing based on the entries in $HOME/.psd/psd.conf as well printout useful information such as profile size, paths, and if any recovery snapshots have been created.
.PP
.nf
.fam C
 $ psd p

 Profile-sync-daemon v6.01 on Arch Linux.

.nf
.fam C
  Systemd service is currently active.
  Systemd timer is currently active.
  Overlayfs v23 is currently active.

.fam T
.fi
.RS
Psd will manage the following per /home/facade/.psd/.facade@mars.pid.conf settings:
.PP
.nf
.fam C
  browser/psname:  chromium/chromium
  owner/group id:  facade/100
  sync target:     /home/facade/.config/chromium
  tmpfs dir:       /run/user/1000/facade-chromium
  profile size:    93M
  overlayfs size:  39M
  recovery dirs:   2 <- delete with the c option
   dir path/size:  /home/facade/.config/chromium-backup-crashrecovery-20150117_171359 (92M)
   dir path/size:  /home/facade/.config/chromium-backup-crashrecovery-20150119_112204 (93M)

  browser/psname:  firefox/firefox
  owner/group id:  facade/100
  sync target:     /home/facade/.mozilla/firefox/f8cv8bfu.default
  tmpfs dir:       /run/user/1000/facade-firefox-f8cv8bfu.default

  profile size:    145M
  overlayfs size:  13M
  recovery dirs:   none

.fam T
.fi
.SS CLEAN MODE
The clean mode will delete ALL recovery snapshots that have accumulated. Run this only if you are sure that you want to delete them.
.PP
.nf
.fam C
 $ psd c

 Profile-sync-daemon v6.01 on Arch Linux.

 Deleting 2 crashrecovery dirs for profile /home/facade/.config/chromium
  /home/facade/.config/chromium-backup-crashrecovery-20150117_171359
  /home/facade/.config/chromium-backup-crashrecovery-20150119_112204

.fam T
.fi
.SS START AND STOP PSD FOR SYSTEMD USERS
With the release of version 6.0 of psd, the only init system that is officially supported is systemd. Psd ships with a service you should use to start or stop it. Additionally, a provided timer file will run the an hourly resync from tmpfs back to the disk. The timer is started automatically with psd.service.
.PP
.nf
.fam C
 $ systemctl --user [option] psd

.fam T
.fi
Available options:
start
stop
enable
disable
.SH SUPPORTED BROWSERS
.IP \(bu 3
Chromium (stable, beta, and dev)
.IP \(bu 3
Conkeror
.IP \(bu 3
Epiphany
.IP \(bu 3
Firefox (stable, beta, and aurora)
.IP \(bu 3
Firefox-trunk (this is an Ubuntu-only browser: http://www.webupd8.org/2011/05/install-firefox-nightly-from-ubuntu-ppa.html)
.IP \(bu 3
Google Chrome (stable, beta, and dev)
.IP \(bu 3
Heftig's version of Aurora (Arch Linux: https://bbs.archlinux.org/viewtopic.php?id=117157)
.IP \(bu 3
Icecat
.IP \(bu 3
Iceweasel
.IP \(bu 3
Inox (https://bbs.archlinux.org/viewtopic.php?id=198763)
.IP \(bu 3
Luakit
.IP \(bu 3
Midori
.IP \(bu 3
Opera (legacy, stable, next, and developer)
.IP \(bu 3
Otter-browser
.IP \(bu 3
Palemoon
.IP \(bu 3
QupZilla
.IP \(bu 3
Rekonq
.IP \(bu 3
Seamonkey
.IP \(bu 3
Vivaldi
.IP \(bu 3
Vivaldi-snapshot
.SS CAVEATS FOR FIREFOX AND ITS KIN
The way psd keeps track of browser profiles and sync targets requires users to have unique name as the last directory for all profiles in their respective $HOME/.mozilla/<browser>/profiles.ini. Psd will check for this and refuse to run if this condition is unsatisfied.
.PP
The following is an example of a BAD profile that will not pass the test. Note that although each full path is unique, they both END in the same name! Again, users must modify the profiles.ini and the corresponding directory on the filesystem to correct this.
.PP
.nf
.fam C
 $ cat ~/.mozilla/firefox/profiles.ini

 [General]
 StartWithLastProfile=1

 [Profile0 for user facade]
 Name=normal
 IsRelative=0
 Path=/mnt/data/docs/facade/mozilla/firefox/myprofile.abc
 Default=1

 [Profile1 for user debbie]
 Name=proxy
 IsRelative=0
 Path=/mnt/data/docs/debbie/mozilla/firefox/myprofile.abc

.fam T
.fi
.SH SUPPORTED DISTROS
At this time, the following distros are officially supported but there is no reason to think that psd will not run on another distro:
.RS
.IP \(bu 3
Arch Linux
.IP \(bu 3
Chakra
.IP \(bu 3
Debian (8+)
.IP \(bu 3
Exherbo
.IP \(bu 3
Fedora (18+)
.IP \(bu 3
Gentoo
.IP \(bu 3
Mint (18+)
.IP \(bu 3
Ubuntu (15.04+)
.IP \(bu 3
Void Linux
.SH ABOUT SYSTEM PRIVACY
Psd uses system tmpfs which is likely world-readable. It is therefore recommended that permissions on \fBprofile\fP(s) should be set to 700 to retain privacy. Psd will honor the permissions set on the profile even if they too are world-readable. Running psd in parse mode (see below) will warn if these are not set to 700 but it is ultimately your choice.
.SH FAQ
Q1: What is overlayfs and why do I want to use it?
.PP
A1: Overlayfs is a simple union file-system mainlined in the Linux kernel version 3.18.0. Starting with psd version 5.54, overlayfs can be used to reduce the memory footprint of psd's tmpfs space and to speed up sync and unsync operations. The magic is in how the overlay mount only writes out data that has changed rather than the entire profile. The same recovery features psd uses in its default mode are also active when running in overlayfs mode. Overlayfs mode is enabled by uncommenting the USE_OVERLAYFS= line and set it to "yes" in $HOME/.psd/psd.conf followed by a restart of the daemon.
.PP
There are several versions of overlayfs available to the Linux kernel in production in various distros. Versions 22 and lower have a module called 'overlayfs' while newer versions (23 and higher) have a module called 'overlay' -- note the lack of the 'fs' in the newer version. Psd will automatically detect the overlayfs available to your kernel if it is configured to use one of them.
.PP
Since version 6.0 of psd, users wanting to user this mode MUST have sudo rights to /usr/bin/mount and /usr/bin/umount. The following line in /etc/sudoers will supply your user with these rights. You may add it using /usr/bin/visudo as root:
.PP
.nf
.fam C
 foo ALL=NOPASSWD: /usr/bin/mount,/usr/bin/umount

.fam T
.fi
See the example in the PREVIEW MODE section above which shows a system using overlayfs to illustrate the memory savings that can be achieved. Note the "overlayfs size" report compared to the total "profile size" report for each profile. Be aware that these numbers will change depending on just how much data is written to the profile, but in common use cases, the overlayfs size will always be less than the profile size.
.PP
Q2: How do I load the overlay or the overlayfs module?
.PP
A2: Simply call /usr/bin/modprobe to load the module (as root) to load it. Again, try 'overlay' first, but if modprobe is unable to locate that module, try 'overlayfs' as a fallback. Note that using modprobe to load the module will NOT reload the module on the next boot. The recommended method to have the needed module load automatically at boot is to place it in /etc/modules-load.d/load_me.conf (the file should contain a single word consisting of just the module name).
.PP
Q3: My system crashed and psd didn't sync back. What do I do?
.PP
A3: Odds are the "last good" backup of your browser \fBprofile\fP(s) is just fine still sitting happily on your filesystem. Upon restarting psd (on a reboot for example), a check is preformed to see if the symlink to the tmpfs copy of your profile is invalid. If it is invalid, psd will snapshot the "last good" backup before it rotates it back into place. This is more for a sanity check that psd did no harm and that any data loss was a function of something else.
.PP
Q4: Where can I find this snapshot?
.PP
A4: It depends on the browser. You will find the snapshot in the same directory as the browser profile and it will contain a date-time-stamp that corresponds to the time at which the recovery took place. For example, a chromium snapshot will be ~/.config/chromium-backup-crashrecovery-20130912_153310 -- of course, the date_time suffix will be different for you.
.PP
Q5: How can I restore the snapshot?
.PP
A5: Follow these steps:
.RS
.IP 1. 4
Stop psd.
.IP 2. 4
Confirm that there is no symlink to the tmpfs browser profile directory. If there is, psd did not stop correctly for other reasons.
.IP 3. 4
Move the "bad" copy of the profile to a backup (don't blindly delete anything).
.IP 4. 4
Copy the snapshot directory to the name that browser expects.
.PP
Example using chromium:
.IP 1. 4
mv ~/.config/chromium ~/.config/chromium-bad
.IP 2. 4
cp \fB-a\fP ~/.config/chromium-backup-crashrecovery-20130912_153310 ~/.config/chromium
.RE
.PP
At this point, launch chromium which will use the backup snapshot you just copied into place. If all is well, it is safe to delete the snapshot. Remember, to start psd, no browsers must be open (or psd will refuse to start).
.PP
Q6: Can psd delete the snapshots automatically?
.PP
A6: Yes, run psd with the "clean" switch to delete snapshots.
.SH CONTRIBUTE
Users wishing to contribute to this code, should fork and send a pull request. Source is freely available on the project page linked below.
.SH BUGS
Discover a bug? Please open an issue on the project page linked below.
.RS
.IP \(bu 3
It is known that on slow systems with large profiles, the initial sync step can sometimes take longer than the boot-up of the WM. Therefore, users can theoretically start their browser before the profile has been transitioned to tmpfs. This is particularly prevalent on systems with slow HDDs running systemd. This effect can be exacerbated with excessively large profiles that store mail as well as browser profiles. Users can minimize this by using overlayfs mode described above. Minimizing the profile size can also help on these systems. See profile-cleaner for more on this: https://github.com/graysky2/profile-cleaner
.IP \(bu 3
Currently, psd does not work with encrypted home directories.
.IP \(bu 3
Currently, psd checks for running browsers before it starts/stops by their name. If you are running a process that happens to contain that name, it will falsely refuse to start until that process is not running. For an example, see: https://github.com/graysky2/profile-sync-daemon/issues/85
.SH ONLINE
.IP \(bu 3
Project page: https://github.com/graysky2/profile-sync-daemon
.IP \(bu 3
Wiki page: https://wiki.archlinux.org/index.php/Profile-sync-daemon
.SH AUTHOR
graysky (graysky AT archlinux DOT us)
